"""
# GraphQL API Schema: Parent Onboarding AI
# Version: 2.0
# This schema defines the contract between the Next.js frontend and the Ruby on Rails backend.
# Updated to match actual backend implementation.
"""

# ------------------------------------------------------------------
# SCALARS
# ------------------------------------------------------------------

scalar DateTime
scalar JSON

# ------------------------------------------------------------------
# ENUMS
# ------------------------------------------------------------------

"""Session status enum matching backend OnboardingSession.status"""
enum SessionStatus {
  STARTED
  IN_PROGRESS
  INSURANCE_PENDING
  ASSESSMENT_COMPLETE
  SUBMITTED
  ABANDONED
  EXPIRED
}

"""Message sender role"""
enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

"""Insurance verification status"""
enum VerificationStatus {
  PENDING
  IN_PROGRESS
  VERIFIED
  FAILED
  MANUAL_REVIEW
  SELF_PAY
}

"""Parent/guardian relationship to child"""
enum RelationshipType {
  PARENT
  GUARDIAN
  GRANDPARENT
  OTHER
}

"""Therapist availability status"""
enum AvailabilityStatus {
  AVAILABLE_THIS_WEEK
  AVAILABLE_NEXT_WEEK
  LIMITED_AVAILABILITY
  WAITLIST
}

# ------------------------------------------------------------------
# CORE TYPES
# ------------------------------------------------------------------

"""Parent/guardian information"""
type Parent {
  id: ID!
  email: String!
  phone: String!
  firstName: String!
  lastName: String!
  relationship: String!
  isGuardian: Boolean!
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""Child information"""
type Child {
  id: ID!
  firstName: String!
  lastName: String!
  dateOfBirth: String!
  gender: String!
  schoolName: String
  grade: String
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""Assessment responses and scoring"""
type Assessment {
  id: ID!
  responses: JSON!
  riskFlags: [String!]!
  summary: String
  consentGiven: Boolean!
  score: Int
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""Insurance information"""
type Insurance {
  id: ID!
  payerName: String!
  subscriberName: String!
  memberId: String!
  policyNumber: String
  groupNumber: String
  verificationStatus: VerificationStatus!
  verificationResult: JSON
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""Chat message in assessment conversation"""
type Message {
  id: ID!
  role: MessageRole!
  content: String!
  metadata: JSON
  createdAt: DateTime!
}

"""Match reason explaining why a therapist was recommended"""
type MatchReason {
  """Reason identifier (e.g., 'specialty_match', 'availability', 'experience')"""
  id: String!
  """Human-readable reason text"""
  text: String!
  """Optional icon identifier for UI display"""
  icon: String
}

"""Therapist information for matching display"""
type Therapist {
  id: ID!
  """Full name of the therapist"""
  name: String!
  """Professional credentials (e.g., 'LMFT', 'PhD', 'LCSW')"""
  credentials: String!
  """Professional photo URL"""
  photoUrl: String
  """Specialty areas (e.g., 'Anxiety', 'Teen Issues', 'ADHD')"""
  specialties: [String!]!
  """Availability status"""
  availabilityStatus: AvailabilityStatus!
  """Human-readable availability text (e.g., 'Available this week')"""
  availabilityText: String!
  """Years of experience"""
  yearsOfExperience: Int
  """Brief bio or description"""
  bio: String
  """Match quality score (0-100, higher is better)"""
  matchScore: Int!
  """Reasons why this therapist was matched"""
  matchReasons: [MatchReason!]!
  """Whether this is the best match (top recommendation)"""
  isBestMatch: Boolean!
}

"""Therapist matching results"""
type TherapistMatchResults {
  """List of matched therapists (2-3 typically)"""
  therapists: [Therapist!]!
  """Total number of therapists matched"""
  totalCount: Int!
  """General explanation of matching criteria"""
  matchingCriteria: String!
}

"""Progress indicators for onboarding session"""
type Progress {
  """Progress percentage (0-100) based on completed required fields"""
  percentage: Int!
  """Current phase in the onboarding flow"""
  currentPhase: String!
  """Array of completed phase names"""
  completedPhases: [String!]!
  """Next phase in the sequence (null if at end)"""
  nextPhase: String
  """Estimated minutes to complete remaining phases (adaptive)"""
  estimatedMinutesRemaining: Int!
}

"""
Onboarding session - the main entity tracking a parent's intake process.
ID is returned in CUID format with sess_ prefix (e.g., sess_abc123...).
"""
type OnboardingSession {
  id: ID!
  status: SessionStatus!
  """Raw session progress data"""
  progressData: JSON!
  """Calculated progress indicators"""
  progress: Progress!
  referralSource: String
  expiresAt: DateTime!
  createdAt: DateTime!
  updatedAt: DateTime!

  # Associated data
  parent: Parent
  child: Child
  assessment: Assessment
  insurance: Insurance
  messages: [Message!]
}

"""Minimal session info returned from createSession (before full onboarding data exists)"""
type SessionInfo {
  id: ID!
  status: String!
}

# ------------------------------------------------------------------
# PAYLOAD TYPES
# ------------------------------------------------------------------

"""Response from createSession mutation"""
type CreateSessionPayload {
  session: OnboardingSession!
  token: String!
  refreshToken: String
}

"""Response from session recovery query"""
type SessionRecoveryPayload {
  session: OnboardingSession!
  token: String!
  refreshToken: String!
}

"""Response from abandonSession mutation"""
type SessionAbandonmentPayload {
  session: OnboardingSession!
  success: Boolean!
}

"""Response from requestSessionRecovery mutation"""
type RequestRecoveryPayload {
  success: Boolean!
  message: String!
}

"""Response from updateSessionProgress mutation"""
type UpdateSessionProgressPayload {
  session: OnboardingSession!
}

"""Response from refreshToken mutation"""
type RefreshTokenPayload {
  success: Boolean!
  error: String
  token: String
  refreshToken: String
  tokenType: String
  expiresIn: Int
}

"""Response from sendMessage mutation"""
type SendMessagePayload {
  userMessage: Message!
  assistantMessage: Message!
  errors: [String!]
}

"""Response from submitInsuranceInfo mutation"""
type SubmitInsuranceInfoPayload {
  session: OnboardingSession!
}

"""Response from setSelfPay mutation"""
type SetSelfPayPayload {
  session: OnboardingSession!
}

# ------------------------------------------------------------------
# INPUT TYPES
# ------------------------------------------------------------------

"""Input for submitting insurance information"""
input SubmitInsuranceInfoInput {
  sessionId: ID!
  payerName: String!
  subscriberName: String!
  memberId: String!
  groupNumber: String
  relationshipToSubscriber: String!
}

# ------------------------------------------------------------------
# QUERIES
# ------------------------------------------------------------------

type Query {
  """
  Get session by ID.
  Requires valid JWT token. User can only access their own session.
  """
  session(id: ID!): OnboardingSession

  """
  Recover session using magic link token.
  No authentication required (token is the credential).
  Returns session with new JWT tokens.
  """
  sessionByRecoveryToken(recoveryToken: String!): SessionRecoveryPayload

  """
  Get matched therapists for a session.
  Requires valid JWT token. Returns 2-3 best-matched therapists
  based on assessment results, child needs, and availability.
  """
  matchedTherapists(sessionId: ID!): TherapistMatchResults

  """Relay-style node lookup"""
  node(id: ID!): Node

  """Relay-style batch node lookup"""
  nodes(ids: [ID!]!): [Node]!
}

# ------------------------------------------------------------------
# MUTATIONS
# ------------------------------------------------------------------

type Mutation {
  """
  Create a new anonymous onboarding session.
  Returns session with JWT token and optional refresh token.
  """
  createSession(
    referralSource: String
    deviceFingerprint: String
  ): CreateSessionPayload

  """
  Update session progress with deep merge.
  Extends session expiration by 1 hour.
  Auto-transitions from STARTED to IN_PROGRESS on first update.
  """
  updateSessionProgress(
    sessionId: ID!
    progress: JSON!
  ): UpdateSessionProgressPayload

  """
  Request session recovery via email magic link.
  Requires parent email to be collected first.
  """
  requestSessionRecovery(sessionId: ID!): RequestRecoveryPayload

  """
  Abandon an onboarding session explicitly.
  Session data is retained per data retention policy.
  Idempotent: abandoning already abandoned session succeeds.
  """
  abandonSession(sessionId: ID!): SessionAbandonmentPayload

  """
  Refresh access token using a valid refresh token.
  Implements token rotation for security.
  """
  refreshToken(
    refreshToken: String!
    deviceFingerprint: String
  ): RefreshTokenPayload

  """
  Send a message in the AI-guided assessment chat.
  Returns both the user message and AI assistant response.
  """
  sendMessage(
    sessionId: ID!
    content: String!
  ): SendMessagePayload

  """
  Submit insurance information for verification.
  Links insurance to the current onboarding session.
  """
  submitInsuranceInfo(input: SubmitInsuranceInfoInput!): SubmitInsuranceInfoPayload

  """
  Mark session as self-pay (no insurance).
  Skips insurance verification step.
  """
  setSelfPay(sessionId: ID!): SetSelfPayPayload
}

# ------------------------------------------------------------------
# SUBSCRIPTIONS
# ------------------------------------------------------------------

type Subscription {
  """Subscribe to updates for a specific session"""
  sessionUpdated(sessionId: ID!): OnboardingSession
}

# ------------------------------------------------------------------
# INTERFACES (Relay)
# ------------------------------------------------------------------

"""Relay Node interface for global object identification"""
interface Node {
  id: ID!
}
