"""
# GraphQL API Schema: Parent Onboarding AI
# Version: 1.0
# This schema defines the contract between the Next.js frontend and the Ruby on Rails backend.
"""

# ------------------------------------------------------------------
# ENUMS
# ------------------------------------------------------------------

enum OnboardingStatus {
  ASSESSMENT_STARTED
  ASSESSMENT_COMPLETED
  DEMOGRAPHICS_COMPLETED
  INSURANCE_PENDING
  INSURANCE_COMPLETED
  SCHEDULING_PENDING
  SCHEDULING_COMPLETED
  ONBOARDING_COMPLETE
}

enum UserRole {
  PARENT
  SUPPORT_STAFF
  ADMIN
}

enum MessageSender {
  USER
  AI
  SUPPORT
}

enum RelationshipType {
  PARENT
  GUARDIAN
  GRANDPARENT
  OTHER
}

# ------------------------------------------------------------------
# CORE TYPES
# ------------------------------------------------------------------

type User {
  id: ID!
  email: String!
  firstName: String
  lastName: String
  role: UserRole!
  createdAt: String!
  children: [Child!]
}

type ParentInfo {
  firstName: String!
  lastName: String!
  email: String!
  phone: String! # E.164 format: +1XXXXXXXXXX
  relationshipToChild: RelationshipType!
}

type Demographics {
  parent: ParentInfo
  child: ChildInfo
  isComplete: Boolean!
}

type ChildInfo {
  firstName: String
  lastName: String
  dateOfBirth: String
  pronouns: String
  concerns: [String!]
}

type Child {
  id: ID!
  firstName: String!
  dateOfBirth: String!
  pronouns: String
  concerns: [String!]
  createdAt: String!
}

type OnboardingSession {
  id: ID!
  status: OnboardingStatus!
  parent: User!
  child: Child!
  assessment: Assessment
  insuranceInfo: InsuranceInformation
  appointment: Appointment
  createdAt: String!
  updatedAt: String!
}

type Assessment {
  id: ID!
  conversationHistory: [ChatMessage!]!
  summary: AssessmentSummary
  isFitForDaybreak: Boolean
  suggestedNextSteps: String
  isComplete: Boolean
}

type AssessmentSummary {
  keyConcerns: [String!]!
  childName: String!
  recommendedFocus: [String!]
  generatedAt: String!
}

type AssessmentSummaryPayload {
  summary: AssessmentSummary!
}

type ConfirmSummaryPayload {
  session: OnboardingSession!
}

type ResetAssessmentPayload {
  session: OnboardingSession!
}

type ChatMessage {
  id: ID!
  sender: MessageSender!
  content: String!
  timestamp: String!
}

type InsuranceInformation {
  id: ID!
  provider: String!
  planName: String
  memberId: String!
  groupId: String
  imageFileUrl: String # URL to the uploaded insurance card image (P1)
}

type Appointment {
  id: ID!
  therapistName: String!
  startTime: String!
  endTime: String!
  confirmationId: String!
}

type CostEstimate {
  copayPerSession: Float
  deductibleRemaining: Float
  notes: String
}

# ------------------------------------------------------------------
# INPUT TYPES
# ------------------------------------------------------------------

input StartOnboardingInput {
  parentEmail: String!
  childFirstName: String!
  childDateOfBirth: String!
}

input SubmitAssessmentMessageInput {
  onboardingSessionId: ID!
  messageContent: String!
}

input UpdateDemographicsInput {
  onboardingSessionId: ID!
  parentFirstName: String
  parentLastName: String
  childPronouns: String
  childConcerns: [String!]
}

input SubmitInsuranceInfoInput {
  onboardingSessionId: ID!
  provider: String!
  planName: String
  memberId: String!
  groupId: String
}

input SubmitInsuranceImageInput {
  onboardingSessionId: ID!
  # The file will be handled via a multipart request, this is a placeholder
  # The mutation will return the extracted info.
}

input ScheduleAppointmentInput {
  onboardingSessionId: ID!
  therapistId: ID!
  timeSlotId: ID!
}

input ParentInfoInput {
  firstName: String!
  lastName: String!
  email: String!
  phone: String! # E.164 format: +1XXXXXXXXXX
  relationshipToChild: RelationshipType!
}

type UpdateParentInfoPayload {
  id: ID!
  status: OnboardingStatus!
  demographics: Demographics
  updatedAt: String!
}

input SendSessionReminderInput {
  sessionId: ID!
  email: String!
}

type SendSessionReminderPayload {
  success: Boolean!
  message: String
}

# ------------------------------------------------------------------
# QUERIES
# ------------------------------------------------------------------

type Query {
  # Get the current state of an onboarding session
  getOnboardingSession(id: ID!): OnboardingSession

  # Get the current authenticated user
  me: User

  # Get available appointment slots for a given therapist/timeframe
  getAvailableSlots(therapistId: ID, startDate: String, endDate: String): [Appointment!]

  # Get a cost estimate based on insurance (P1)
  getCostEstimate(onboardingSessionId: ID!): CostEstimate
}

# ------------------------------------------------------------------
# MUTATIONS
# ------------------------------------------------------------------

type Mutation {
  # P0: Start the onboarding process and create the initial records
  startOnboarding(input: StartOnboardingInput!): OnboardingSession

  # P0: Send a message to the AI assessment chatbot and get a response
  submitAssessmentMessage(input: SubmitAssessmentMessageInput!): Assessment

  # P0: Complete assessment and generate summary (Story 2.5)
  completeAssessment(sessionId: ID!): AssessmentSummaryPayload

  # P0: Confirm assessment summary and enable navigation (Story 2.5)
  confirmAssessmentSummary(sessionId: ID!, confirmed: Boolean!): ConfirmSummaryPayload

  # P0: Reset assessment to start over (Story 2.5)
  resetAssessment(sessionId: ID!): ResetAssessmentPayload

  # P0: Send email reminder to return to session (Story 2.6)
  sendSessionReminder(input: SendSessionReminderInput!): SendSessionReminderPayload

  # P0: Update parent and child demographic information
  updateDemographics(input: UpdateDemographicsInput!): OnboardingSession

  # P0: Update parent info specifically (Story 3.1)
  updateParentInfo(sessionId: ID!, input: ParentInfoInput!): UpdateParentInfoPayload

  # P0: Manually submit insurance information
  submitInsuranceInfo(input: SubmitInsuranceInfoInput!): OnboardingSession

  # P0: Select a therapist and time to book an appointment
  scheduleAppointment(input: ScheduleAppointmentInput!): Appointment

  # P1: Upload an insurance card image for OCR processing
  submitInsuranceImage(onboardingSessionId: ID!): InsuranceInformation

  # P1: Send a message in the real-time support chat
  sendSupportChatMessage(onboardingSessionId: ID!, content: String!): ChatMessage
}

# ------------------------------------------------------------------
# SUBSCRIPTIONS (for P1 Real-time Chat)
# ------------------------------------------------------------------

type Subscription {
  # Subscribe to new messages in a support chat session
  supportChatMessages(onboardingSessionId: ID!): ChatMessage
}
