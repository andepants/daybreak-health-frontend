<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>3</storyId>
    <title>Support Availability and Request Tracking</title>
    <status>drafted</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/7-3-support-availability-request-tracking.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>parent reaching out for help</asA>
    <iWant>to know when I'll get a response and track my request</iWant>
    <soThat>I don't feel ignored or abandoned</soThat>
    <tasks>
- Configure Intercom Office Hours Feature (AC: #2)
  - Set business hours in Intercom dashboard
  - Configure away mode messages and expected response times
  - Test after-hours experience displays correctly

- Set Up Crisis Response Automation (AC: #4)
  - Configure keyword triggers in Intercom for crisis terms ("suicide", "emergency", "crisis", "harm")
  - Create automated response with immediate resources (crisis hotline numbers, 988)
  - Set up alerts to staff when crisis keywords detected
  - Test automation triggers correctly

- Verify Native Availability Features (AC: #1)
  - Confirm availability indicator displays correctly
  - Verify team member avatars appear when online
  - Test "Typically replies in X minutes" calculation
  - Validate real-time updates when staff status changes

- Configure Email Notifications (AC: #2, #3)
  - Enable email notification option in Intercom messenger
  - Configure notification templates for after-hours replies
  - Test email delivery when staff responds
  - Verify push notification settings work correctly

- Implement Backend Webhook Integration (AC: #6)
  - Set up Intercom webhook endpoint in backend
  - Configure webhooks for conversation events (created, replied, closed)
  - Implement webhook handler to store support request metadata
  - Add analytics tracking for response times and topics
  - Test webhook delivery and data storage

- Test Message Status Indicators (AC: #3)
  - Verify "Sent" indicator appears after message submission
  - Confirm typing indicator displays when staff types
  - Test notification delivery (push and email)
  - Validate message status updates in real-time

- Test Conversation Persistence (AC: #5)
  - Send messages and close browser
  - Reopen and verify conversation history loads
  - Test across different devices with same user
  - Verify conversation context persists after days
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Availability Indicator Display**
   - When Intercom messenger loads, the interface displays:
     - Real-time availability indicator from Intercom
     - "Typically replies in X minutes" message (Intercom native feature)
     - Team member photos/avatars showing who's available

2. **After-Hours Experience**
   - Intercom's built-in away mode activates when support is offline
   - "Leave a message" prompt with expected response time
   - Email notification option for replies is available

3. **Message Status and Response Tracking**
   - After sending a message:
     - Message shows "Sent" indicator
     - Typing indicator appears when staff responds
     - Push/email notification when reply arrives

4. **Crisis Support Integration**
   - Crisis keywords (e.g., "suicide", "emergency") trigger immediate resources
   - Crisis response automation configured in Intercom dashboard

5. **Conversation Persistence**
   - Conversation history persists across browser sessions
   - User can access previous conversations on return

6. **Backend Analytics Tracking**
   - Support requests are tracked in backend via Intercom webhooks
   - Analytics capture response times, resolution rates, and conversation topics
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 7: Support Interface</title>
        <section>Story 7.3: Support Availability and Request Tracking</section>
        <snippet>Provides real-time human support via Intercom throughout the onboarding flow, ensuring parents never feel trapped. FR-014: The system shall provide real-time chat support connecting parents with Daybreak staff during onboarding.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>6.5 Support & Communication</section>
        <snippet>FR-014: The system shall provide real-time chat support connecting parents with Daybreak staff during onboarding. [MVP] (moved from Growth per Architecture ADR-005 for emotional safety)</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Pre-mortem Risk Mitigations</section>
        <snippet>Risk: "Parents feel trapped" (can't reach human). Preventive Measure: Intercom widget always visible. Priority: MVP. Implementation: Epic 7 - Live support escalation pathway.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/stories/7-1-intercom-widget-integration.md</path>
        <title>Story 7.1: Intercom Widget Integration</title>
        <section>Full Story</section>
        <snippet>Implements core Intercom widget integration with IntercomProvider component. Provides foundation for Story 7.3 availability features. Uses environment variable NEXT_PUBLIC_INTERCOM_APP_ID for configuration.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/stories/7-3-support-availability-request-tracking.md</path>
        <title>Current Story</title>
        <section>Dev Notes - Intercom Configuration Requirements</section>
        <snippet>This story is primarily configuration-focused rather than code-heavy. Most functionality is provided natively by Intercom with proper dashboard configuration. Features Used: Office Hours, Availability Indicator, Expected Reply Time, Away Mode, Crisis Keywords, Webhooks.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/stories/7-3-support-availability-request-tracking.md</path>
        <title>Current Story</title>
        <section>Dev Notes - Crisis Response Automation</section>
        <snippet>Critical Safety Feature: Crisis keyword detection must be configured with highest priority in Intercom. Keywords: suicide, emergency, crisis, harm, self-harm. Automated response provides 988 Suicide & Crisis Lifeline, 911, Crisis Text Line (741741). Staff alert via Slack and email when crisis keywords detected.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/stories/7-3-support-availability-request-tracking.md</path>
        <title>Current Story</title>
        <section>Dev Notes - Backend Implementation</section>
        <snippet>Backend must implement webhook endpoint to receive Intercom events. Events to track: conversation.created, conversation.user.replied, conversation.admin.replied, conversation.closed. Store metadata: response time, conversation topic/tags, resolution status, crisis keyword flags.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/stories/7-3-support-availability-request-tracking.md</path>
        <title>Current Story</title>
        <section>Dev Notes - Privacy & Security</section>
        <snippet>PHI Protection: Conversation content stays in Intercom (BAA in place). Backend analytics only store non-PHI metadata: Session ID, onboarding step, response time metrics, topic tags. No assessment details, child names, or medical info passed to backend analytics. HIPAA Compliance: Intercom has signed BAA, webhook data transmission over HTTPS, webhook endpoint requires authentication token.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>providers/IntercomProvider.tsx</path>
        <kind>provider</kind>
        <symbol>IntercomProvider</symbol>
        <lines>N/A - To be created in Story 7.1</lines>
        <reason>Story 7.1 creates the IntercomProvider component that initializes Intercom widget. Story 7.3 relies on this foundation being in place. No code changes to provider needed - configuration happens in Intercom dashboard.</reason>
      </artifact>
      <artifact>
        <path>app/layout.tsx</path>
        <kind>layout</kind>
        <symbol>RootLayout</symbol>
        <lines>N/A - Modified in Story 7.1</lines>
        <reason>Story 7.1 wraps app with IntercomProvider. Story 7.3 requires no additional layout changes - all features are Intercom-native or backend-configured.</reason>
      </artifact>
      <artifact>
        <path>package.json</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <lines>16-41</lines>
        <reason>No new frontend dependencies required for Story 7.3. Intercom SDK installed in Story 7.1. Backend webhook integration handled server-side.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>@intercom/messenger-js-sdk</package>
        <version>To be added in Story 7.1</version>
        <purpose>Intercom JavaScript SDK for widget integration (if using npm approach vs script tag)</purpose>
      </node>
      <node>
        <package>next</package>
        <version>16.0.5</version>
        <purpose>Next.js framework - provides Script component for async loading if using script tag approach</purpose>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
- **Configuration-First Approach**: This story is primarily Intercom dashboard configuration, not frontend code implementation. Most features (availability indicator, office hours, crisis automation) are Intercom-native and configured via their admin panel.

- **No Frontend Code Changes**: Story requires NO new frontend components or code. All functionality provided by Intercom's native messenger interface which is already integrated via Story 7.1.

- **Backend Dependency**: Backend team must implement webhook endpoint to receive and process Intercom conversation events. Frontend has no direct involvement in webhook implementation.

- **PHI Protection**: No PHI (Protected Health Information) can be passed to backend analytics from Intercom webhooks. Only non-sensitive metadata: session ID, onboarding step, response time metrics, generic topic tags.

- **HIPAA Compliance**: Intercom conversation content must remain in Intercom platform (which has signed BAA with Daybreak Health). Webhook data transmission must use HTTPS only. Backend webhook endpoint must require authentication token.

- **Crisis Response Priority**: Crisis keyword automation must be configured as highest priority in Intercom to ensure immediate response. Automated message provides crisis hotline resources (988, 911, Crisis Text Line). Staff alerts must trigger immediately (Slack + email).

- **Testing Focus**: Testing is primarily manual verification of Intercom dashboard configuration (office hours, crisis automation, webhooks) and integration testing with backend webhook endpoint.

- **Story Dependencies**: Requires Story 7.1 (Intercom Widget Integration) to be completed first. Story 7.2 (Session Context Passing) is parallel but provides enhanced context for support staff.
  </constraints>

  <interfaces>
    <interface>
      <name>Intercom Office Hours API</name>
      <kind>Intercom Dashboard Configuration</kind>
      <signature>Business hours configuration in Intercom settings - defines when support is available, triggers away mode automatically</signature>
      <path>Configured via Intercom admin dashboard, not code</path>
    </interface>
    <interface>
      <name>Intercom Automation Rules API</name>
      <kind>Intercom Dashboard Configuration</kind>
      <signature>Crisis keyword triggers configured as automation rules in Intercom - detects keywords in user messages, sends automated response, alerts staff</signature>
      <path>Configured via Intercom admin dashboard under "Automation"</path>
    </interface>
    <interface>
      <name>Intercom Webhooks API</name>
      <kind>Backend REST Endpoint</kind>
      <signature>POST /api/webhooks/intercom - Receives conversation events from Intercom (conversation.created, conversation.user.replied, conversation.admin.replied, conversation.closed). Payload includes conversation metadata for analytics tracking.</signature>
      <path>Backend implementation - Story 7-3 in backend epic</path>
    </interface>
    <interface>
      <name>Intercom Messenger Native Features</name>
      <kind>Intercom Native UI</kind>
      <signature>Availability indicator, typing indicator, message status, expected reply time - all provided by Intercom messenger interface natively, no custom implementation needed</signature>
      <path>Intercom widget UI - configured via Story 7.1 integration</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
This story is configuration and integration testing focused rather than unit testing focused. Testing verifies Intercom dashboard configuration is correct and backend webhook integration functions properly. No new frontend components means no new unit tests required. Manual testing and integration testing with backend are primary validation approaches.

Frontend testing standards from architecture (Vitest for unit tests, Playwright for E2E) do not apply to this story as there is no frontend code implementation. Backend team will write tests for webhook endpoint.
    </standards>

    <locations>
- **Intercom Dashboard**: Manual verification of office hours configuration, crisis automation rules, webhook settings
- **Backend Tests**: Backend team responsible for webhook endpoint tests (not frontend scope)
- **Integration Tests**: Manual/automated testing of end-to-end webhook delivery from Intercom to backend
    </locations>

    <ideas>
**AC #1 - Availability Indicator Display:**
- Manual test: Open Intercom messenger during business hours, verify availability indicator shows "Online" with team member avatars
- Manual test: Verify "Typically replies in X minutes" message displays based on team response patterns
- Manual test: Change staff status in Intercom dashboard, verify real-time update in messenger

**AC #2 - After-Hours Experience:**
- Manual test: Open messenger outside business hours (or simulate via Intercom settings), verify away mode activated
- Manual test: Verify "Leave a message" prompt appears with expected response time
- Manual test: Confirm email notification option is available for replies

**AC #3 - Message Status and Response Tracking:**
- Manual test: Send test message, verify "Sent" indicator appears
- Manual test: Have staff member respond, verify typing indicator displays
- Manual test: Verify push/email notification received when reply arrives

**AC #4 - Crisis Support Integration:**
- Manual test: Send message with crisis keyword ("suicide"), verify automated response appears immediately
- Manual test: Verify automated response contains 988 hotline, 911, Crisis Text Line
- Manual test: Confirm staff alert sent to Slack and email when crisis keyword detected
- Test each crisis keyword: suicide, emergency, crisis, harm, self-harm, kill myself, end my life, don't want to live

**AC #5 - Conversation Persistence:**
- Manual test: Send messages, close browser, reopen and verify conversation history loads
- Manual test: Access same conversation from different device with same user
- Manual test: Verify conversation context persists after several days

**AC #6 - Backend Analytics Tracking:**
- Integration test: Trigger conversation events (create, reply, close), verify webhook POST received by backend
- Backend test: Verify support request metadata stored (response time, topic, resolution status, crisis flags)
- Backend test: Verify analytics capture response times and conversation topics correctly
    </ideas>
  </tests>
</story-context>
