# Architecture: Daybreak Health Parent Onboarding AI

**Version:** 1.0
**Date:** 2025-11-28
**Author:** Generated by BMAD Decision Architecture Workflow
**Status:** Ready for Implementation

---

## Executive Summary

The Daybreak Health Parent Onboarding AI is a HIPAA-compliant, mobile-first web application that guides stressed parents through mental health intake for their children (ages 10-19) using AI-assisted conversational assessment. The architecture prioritizes **trust formation in the first 30 seconds**, **emotional safety throughout**, and **graceful degradation** when AI or real-time features encounter issues.

The frontend is a stateless Next.js 15 application deployed to AWS S3/CloudFront, communicating with a Ruby on Rails 7 backend via GraphQL. This architecture document serves as the **consistency contract for all AI agents** implementing the system.

**Key Architectural Principles:**
1. Mobile-first is fundamental, not a feature
2. Form-based fallback exists alongside AI chat
3. Human support escalation is always visible
4. Every message persists immediately
5. No PHI in frontend state, logs, or URLs

---

## Project Initialization

**First implementation story must execute:**

```bash
# Create Next.js 15 project with recommended defaults
npx create-next-app@latest daybreak-health-frontend --typescript --tailwind --eslint --app --use-pnpm

# Navigate to project
cd daybreak-health-frontend

# Initialize shadcn/ui (Tailwind v4 compatible)
pnpm dlx shadcn@latest init

# Install core dependencies
pnpm add @apollo/client @apollo/client-integration-nextjs graphql graphql-ws
pnpm add react-hook-form @hookform/resolvers zod
pnpm add -D @graphql-codegen/cli @graphql-codegen/typescript @graphql-codegen/typescript-operations @graphql-codegen/typescript-react-apollo
```

**Starter-Provided Decisions:**
| Decision | Provided By |
|----------|-------------|
| TypeScript | create-next-app |
| App Router | create-next-app |
| Tailwind CSS 4 | create-next-app |
| ESLint | create-next-app |
| Turbopack (dev) | create-next-app |
| Import alias @/* | create-next-app |

---

## Decision Summary

| Category | Decision | Version | Affects FRs | Rationale |
|----------|----------|---------|-------------|-----------|
| Framework | Next.js | 15.x | All | App Router, RSC, Turbopack, static export for S3/CloudFront |
| UI Library | React | 19.x | All | Latest features: `use` hook, Actions, ref as prop |
| Language | TypeScript | 5.x | All | End-to-end type safety from GraphQL to components |
| API Client | Apollo Client | 4.x | FR-001-015 | With `@apollo/client-integration-nextjs` for App Router |
| Real-time | graphql-ws | 6.x | FR-014 | WebSocket client for GraphQL subscriptions |
| Styling | Tailwind CSS | 4.0 | All | CSS-first config, requires modern browsers |
| Components | shadcn/ui | Latest | All | Accessible, customizable, Tailwind-native |
| Forms | React Hook Form | 7.x | FR-004-010 | Performant, uncontrolled, minimal re-renders |
| Validation | Zod | 3.x | FR-004-010 | TypeScript-first schema validation (v3 for stability) |
| Code Gen | GraphQL Codegen | 5.x | All | Type-safe hooks from schema |
| Unit Testing | Vitest | 3.x | All | Fast, ESM-native, React Testing Library |
| E2E Testing | Playwright | 1.x | Critical flows | Cross-browser, TypeScript, parallel execution |
| Linting | ESLint + Prettier | 9.x / 3.x | All | Consistent code style |
| Package Manager | pnpm | 9.x | All | Fast, disk-efficient |

---

## Fundamental Truths (First Principles)

These irreducible truths drive all architectural decisions:

| Fundamental Truth | Architectural Implication |
|-------------------|---------------------------|
| **PHI must be protected** | Encryption at rest/transit, access controls, audit logs are non-negotiable. No PHI in frontend state, logs, or URLs. |
| **Parents are emotionally stressed** | UX must be warm, forgiving of errors, allow pause/resume. Save progress on every interaction. |
| **Insurance is a friction point** | Photo capture as optional enhancement, manual entry as reliable primary path. |
| **AI responses take time (1-3s)** | UI must handle latency gracefully with typing indicators, optimistic UI, skeleton states. |
| **Therapist availability is finite** | Matching must balance fit with availability and show transparent reasoning. |
| **Mobile is primary device** | Mobile-first is fundamental, not a feature. All components designed mobile-native first. |
| **Trust must be earned quickly** | Performance budget: <1.5s LCP. Clear value proposition in first 30 seconds. |

---

## Pre-mortem Risk Mitigations

Architecture requirements derived from failure scenario analysis:

| Risk | Preventive Measure | Priority | Implementation |
|------|-------------------|----------|----------------|
| AI chat abandonment | Form-based fallback flow available | MVP | Parallel `/onboarding/[id]/form/*` routes |
| Parents feel trapped | Human support escalation always visible | MVP | Floating support button on all screens |
| Context lost on refresh | Persist every message to backend immediately | MVP | Optimistic save on every `sendMessage` |
| OCR failure dead end | Manual entry is primary, OCR is enhancement | MVP | OCR as "Try photo first" optional step |
| WebSocket fragility | Exponential backoff reconnection logic | MVP | Apollo Link retry configuration |
| PHI leaks | Frontend PHI audit checklist | MVP | No console.log of PHI, no URL params |
| Third-party data leak | Audit all dependencies for HIPAA BAA | MVP | Create approved vendor list |
| Load uncertainty | Load test at 2x target before launch | Pre-launch | k6 or Artillery in CI |
| Black box matching | Show "matched because..." with 3 reasons | MVP | Matching rationale in API response |

---

## Project Structure

```
daybreak-health-frontend/
├── app/                              # Next.js App Router
│   ├── layout.tsx                    # Root layout with providers
│   ├── page.tsx                      # Landing page
│   ├── globals.css                   # Tailwind imports + Daybreak theme
│   ├── onboarding/
│   │   └── [sessionId]/
│   │       ├── layout.tsx            # Onboarding layout (progress bar, support button)
│   │       ├── page.tsx              # Session entry redirect
│   │       ├── assessment/
│   │       │   └── page.tsx          # AI chat assessment (FR-001-003)
│   │       ├── form/                 # Form-based fallback flow
│   │       │   ├── assessment/
│   │       │   │   └── page.tsx      # Traditional form assessment
│   │       │   └── page.tsx          # Form flow entry
│   │       ├── demographics/
│   │       │   └── page.tsx          # Parent/child info (FR-004-006)
│   │       ├── insurance/
│   │       │   └── page.tsx          # Insurance entry/OCR (FR-008-010)
│   │       ├── matching/
│   │       │   └── page.tsx          # Therapist results (FR-011)
│   │       └── schedule/
│   │           └── page.tsx          # Appointment booking (FR-012-013)
│   └── api/                          # API routes (if needed for BFF)
├── components/
│   ├── ui/                           # shadcn/ui components
│   │   ├── button.tsx
│   │   ├── input.tsx
│   │   ├── card.tsx
│   │   ├── dialog.tsx
│   │   ├── progress.tsx
│   │   ├── skeleton.tsx
│   │   ├── toast.tsx
│   │   └── ...
│   ├── layout/
│   │   ├── Header.tsx                # Minimal header with logo
│   │   ├── OnboardingProgress.tsx    # Step indicator
│   │   ├── SupportButton.tsx         # Floating human support CTA
│   │   └── Footer.tsx                # Privacy, terms links
│   └── shared/
│       ├── ErrorBoundary.tsx         # Global error handling
│       ├── LoadingScreen.tsx         # Full-page loading state
│       └── PrivacyModeToggle.tsx     # Hide sensitive info on screen
├── features/
│   ├── assessment/
│   │   ├── ChatWindow.tsx            # Main AI chat container
│   │   ├── ChatBubble.tsx            # AI/user message bubble
│   │   ├── QuickReplyChips.tsx       # Tap-to-respond options
│   │   ├── TypingIndicator.tsx       # AI "thinking" animation
│   │   ├── useAssessmentChat.ts      # Chat state + mutations
│   │   └── assessment.graphql        # GraphQL operations
│   ├── demographics/
│   │   ├── ParentInfoForm.tsx        # Parent contact form
│   │   ├── ChildInfoForm.tsx         # Child details form
│   │   ├── useDemographics.ts        # Form state + mutations
│   │   └── demographics.graphql
│   ├── insurance/
│   │   ├── InsuranceForm.tsx         # Manual entry form
│   │   ├── InsuranceScanner.tsx      # Camera/upload component
│   │   ├── OcrResultReview.tsx       # Verify extracted data
│   │   ├── useInsurance.ts           # Insurance state + mutations
│   │   └── insurance.graphql
│   ├── matching/
│   │   ├── TherapistCard.tsx         # Matched therapist display
│   │   ├── MatchRationale.tsx        # "Matched because..." display
│   │   ├── useMatching.ts            # Matching query
│   │   └── matching.graphql
│   ├── scheduling/
│   │   ├── Calendar.tsx              # Available slots display
│   │   ├── TimeSlotPicker.tsx        # Slot selection
│   │   ├── Confirmation.tsx          # Booking success
│   │   ├── useScheduling.ts          # Scheduling mutations
│   │   └── scheduling.graphql
│   └── support-chat/
│       ├── SupportChatWidget.tsx     # Real-time support chat
│       ├── useSupportChat.ts         # Subscription hook
│       └── support-chat.graphql
├── graphql/
│   ├── queries/                      # .graphql query files
│   ├── mutations/                    # .graphql mutation files
│   ├── subscriptions/                # .graphql subscription files
│   └── fragments/                    # Shared fragments
├── hooks/
│   ├── useOnboardingSession.ts       # Session state management
│   ├── useAutoSave.ts                # Aggressive auto-save hook
│   └── useWebSocketReconnect.ts      # Reconnection with backoff
├── lib/
│   ├── apollo/
│   │   ├── client.ts                 # Apollo Client configuration
│   │   ├── provider.tsx              # ApolloProvider wrapper
│   │   └── links.ts                  # HTTP + WebSocket link setup
│   ├── validations/
│   │   ├── demographics.ts           # Zod schemas
│   │   ├── insurance.ts
│   │   └── common.ts
│   └── utils/
│       ├── formatters.ts             # Date, phone, name formatting
│       └── phi-guard.ts              # PHI logging prevention
├── providers/
│   ├── AuthProvider.tsx              # JWT + session management
│   ├── OnboardingProvider.tsx        # Onboarding context
│   └── ThemeProvider.tsx             # Daybreak theme
├── types/
│   └── graphql.ts                    # Generated GraphQL types
├── public/
│   ├── fonts/                        # Fraunces + Inter fonts
│   └── images/                       # Static assets
├── tests/
│   ├── unit/                         # Vitest tests
│   ├── e2e/                          # Playwright tests
│   └── mocks/                        # MSW handlers
├── .env.example                      # Environment template
├── .env.local                        # Local environment (gitignored)
├── codegen.ts                        # GraphQL Code Generator config
├── components.json                   # shadcn/ui config
├── next.config.ts                    # Next.js configuration
├── tailwind.config.ts                # Tailwind + Daybreak theme
├── tsconfig.json                     # TypeScript configuration
├── vitest.config.ts                  # Vitest configuration
├── playwright.config.ts              # Playwright configuration
└── package.json
```

---

## FR Category to Architecture Mapping

| FR Category | Components | Route | Key Files |
|-------------|-----------|-------|-----------|
| **Assessment & Screening** (FR-001-003) | ChatWindow, ChatBubble, QuickReplyChips | `/onboarding/[id]/assessment` | `features/assessment/*` |
| **Onboarding & Data Collection** (FR-004-007) | ParentInfoForm, ChildInfoForm | `/onboarding/[id]/demographics` | `features/demographics/*` |
| **Insurance Management** (FR-008-010) | InsuranceForm, InsuranceScanner, OcrResultReview | `/onboarding/[id]/insurance` | `features/insurance/*` |
| **Scheduling** (FR-011-013) | TherapistCard, MatchRationale, Calendar, TimeSlotPicker | `/onboarding/[id]/matching`, `/onboarding/[id]/schedule` | `features/matching/*`, `features/scheduling/*` |
| **Support & Communication** (FR-014-015) | SupportChatWidget, SupportButton | Global (floating) | `features/support-chat/*`, `components/layout/SupportButton.tsx` |
| **Session Persistence** (FR-007) | useAutoSave, useOnboardingSession | All onboarding routes | `hooks/useAutoSave.ts`, `hooks/useOnboardingSession.ts` |

---

## Technology Stack Details

### Core Technologies

| Technology | Version | Purpose | Installation |
|------------|---------|---------|--------------|
| **Next.js** | 15.x | App Router, RSC, static export | `create-next-app` |
| **React** | 19.x | UI library with latest features | Bundled with Next.js |
| **TypeScript** | 5.x | Type safety | Bundled with Next.js |
| **Apollo Client** | 4.x | GraphQL client, caching, subscriptions | `@apollo/client` |
| **Apollo Next.js** | Latest | App Router integration | `@apollo/client-integration-nextjs` |
| **graphql-ws** | 6.x | WebSocket subscriptions | `graphql-ws` |
| **Tailwind CSS** | 4.0 | Utility-first styling | Bundled with Next.js |
| **shadcn/ui** | Latest | Component library | `shadcn` CLI |
| **React Hook Form** | 7.x | Form state management | `react-hook-form` |
| **Zod** | 3.x | Schema validation | `zod` + `@hookform/resolvers` |
| **GraphQL Codegen** | 5.x | Type generation | `@graphql-codegen/*` |

### Development Tools

| Tool | Version | Purpose |
|------|---------|---------|
| **Vitest** | 3.x | Unit testing (ESM-native) |
| **React Testing Library** | 16.x | Component testing |
| **Playwright** | 1.x | E2E testing |
| **MSW** | 2.x | API mocking |
| **ESLint** | 9.x | Linting |
| **Prettier** | 3.x | Code formatting |
| **pnpm** | 9.x | Package management |

### Integration Points

| Integration | Protocol | Endpoint | Purpose |
|-------------|----------|----------|---------|
| Backend API | GraphQL over HTTPS | `NEXT_PUBLIC_GRAPHQL_ENDPOINT` | Queries, mutations |
| Real-time | GraphQL over WebSocket | `NEXT_PUBLIC_WS_ENDPOINT` | Subscriptions |
| Backend WebSocket | Action Cable | `/cable` | GraphQL subscription transport |

---

## Implementation Patterns

These patterns ensure consistent implementation across all AI agents:

### Naming Patterns

| Entity | Convention | Example |
|--------|------------|---------|
| Components | PascalCase | `ChatBubble.tsx`, `InsuranceForm.tsx` |
| Hooks | camelCase with `use` prefix | `useAssessmentChat.ts` |
| GraphQL files | kebab-case | `get-session.graphql` |
| GraphQL operations | PascalCase | `GetOnboardingSession`, `SubmitAssessmentMessage` |
| Zod schemas | camelCase with `Schema` suffix | `parentInfoSchema`, `insuranceSchema` |
| CSS classes | Tailwind utilities | `className="flex items-center gap-2"` |
| Environment vars | SCREAMING_SNAKE_CASE | `NEXT_PUBLIC_GRAPHQL_ENDPOINT` |

### Structure Patterns

| Concern | Location | Rationale |
|---------|----------|-----------|
| Route components | `app/` | Next.js App Router convention |
| Feature components | `features/[feature]/` | Co-located with feature logic |
| Shared UI | `components/ui/` | shadcn/ui components |
| Layout components | `components/layout/` | Page structure |
| GraphQL operations | `features/[feature]/*.graphql` | Co-located with consumers |
| Custom hooks | `features/[feature]/use*.ts` or `hooks/` | Near usage or shared |
| Zod schemas | `lib/validations/` | Centralized validation logic |

### Format Patterns

| Format | Convention | Example |
|--------|------------|---------|
| API dates | ISO 8601 strings | `"2025-11-28T10:30:00Z"` |
| Display dates | Localized | `Intl.DateTimeFormat` |
| Phone numbers | E.164 format in API | `+15551234567` |
| Display phones | Formatted for readability | `(555) 123-4567` |
| Currency | Cents in API, formatted in UI | `12500` → `$125.00` |
| API errors | `{ message, code, field? }` | `{ message: "Invalid email", code: "VALIDATION_ERROR", field: "email" }` |

### Communication Patterns

| Pattern | Implementation |
|---------|----------------|
| Query caching | Apollo Client normalized cache |
| Optimistic updates | Apollo `optimisticResponse` for mutations |
| Subscription updates | `subscribeToMore` for cache integration |
| Error boundaries | React Error Boundary at route level |
| Loading states | Suspense + Skeleton components |
| Toast notifications | `sonner` via shadcn/ui toast |

### Lifecycle Patterns

| State | Pattern |
|-------|---------|
| Loading | Skeleton component matching content shape |
| Error | Inline error message + retry option |
| Empty | Helpful message + primary action |
| Success | Toast notification (4s auto-dismiss) |
| AI thinking | Typing indicator with animated dots |
| Form submitting | Button disabled + spinner |

### Location Patterns

| Asset Type | Location |
|------------|----------|
| Static images | `public/images/` |
| Fonts | `public/fonts/` or `next/font` |
| API routes (if needed) | `app/api/` |
| Generated types | `types/graphql.ts` |
| Test files | `tests/` (separate from source) |

---

## Consistency Rules

### Naming Conventions

```typescript
// Components: PascalCase
export function ChatBubble({ message, sender }: ChatBubbleProps) {}

// Hooks: camelCase with use prefix
export function useAssessmentChat(sessionId: string) {}

// Types: PascalCase with descriptive suffix
interface ChatBubbleProps {}
type OnboardingStatus = 'in_progress' | 'completed' | 'abandoned';

// Constants: SCREAMING_SNAKE_CASE
const MAX_MESSAGE_LENGTH = 2000;
const API_TIMEOUT_MS = 30000;

// GraphQL operations: PascalCase matching operation type
query GetOnboardingSession($id: ID!) {}
mutation SubmitAssessmentMessage($input: MessageInput!) {}
subscription SupportChatMessages($sessionId: ID!) {}
```

### Code Organization

```typescript
// Component file structure (consistent order)
// 1. Imports (external, then internal, then types)
// 2. Types/interfaces
// 3. Constants
// 4. Helper functions
// 5. Component
// 6. Export

import { useState } from 'react';
import { useMutation } from '@apollo/client';

import { Button } from '@/components/ui/button';
import { useAutoSave } from '@/hooks/useAutoSave';

import type { MessageInput } from '@/types/graphql';

interface ChatInputProps {
  sessionId: string;
  onSend: (message: string) => void;
}

const MAX_LENGTH = 2000;

function validateMessage(text: string): boolean {
  return text.trim().length > 0 && text.length <= MAX_LENGTH;
}

export function ChatInput({ sessionId, onSend }: ChatInputProps) {
  // Component implementation
}
```

### Error Handling

```typescript
// Global error boundary at route level
// app/onboarding/[sessionId]/layout.tsx
<ErrorBoundary fallback={<OnboardingErrorFallback />}>
  {children}
</ErrorBoundary>

// GraphQL errors: Check for specific codes
const { error } = useQuery(GetSessionDocument);
if (error?.graphQLErrors.some(e => e.extensions?.code === 'UNAUTHENTICATED')) {
  redirect('/');
}

// Network errors: Show toast with retry
if (error?.networkError) {
  toast.error('Connection lost. Please check your internet.', {
    action: { label: 'Retry', onClick: () => refetch() }
  });
}

// Form validation: Inline errors below fields
<Input {...register('email')} />
{errors.email && (
  <p className="text-sm text-red-500 mt-1">{errors.email.message}</p>
)}
```

### Logging Strategy

```typescript
// CRITICAL: No PHI in logs
import { phiGuard } from '@/lib/utils/phi-guard';

// Safe logging
console.log('Session started:', { sessionId }); // OK - ID only
console.log('Step completed:', { step: 'demographics' }); // OK

// NEVER log PHI
console.log('User data:', userData); // FORBIDDEN
console.log('Child name:', childName); // FORBIDDEN

// phiGuard utility strips PHI before logging
const safeData = phiGuard(userData);
console.log('Sanitized:', safeData); // OK - PHI removed
```

---

## Data Architecture

### Frontend State Model

```typescript
// Onboarding session state (managed by Apollo Client cache)
interface OnboardingSession {
  id: string;
  status: 'in_progress' | 'assessment' | 'demographics' | 'insurance' | 'matching' | 'scheduling' | 'completed';
  createdAt: string;
  updatedAt: string;

  // Child info (collected in demographics)
  child?: {
    firstName: string;
    dateOfBirth: string;
    pronouns?: string;
  };

  // Assessment state
  assessment?: {
    conversationHistory: Message[];
    currentQuestion?: string;
    isComplete: boolean;
  };

  // Demographics state
  demographics?: {
    parent: ParentInfo;
    child: ChildInfo;
    isComplete: boolean;
  };

  // Insurance state
  insurance?: {
    carrier?: string;
    memberId?: string;
    groupNumber?: string;
    isVerified: boolean;
  };

  // Matching results
  matchedTherapists?: TherapistMatch[];

  // Scheduled appointment
  appointment?: {
    therapistId: string;
    dateTime: string;
    confirmed: boolean;
  };
}
```

### Cache Normalization

```typescript
// Apollo Client cache configuration
const cache = new InMemoryCache({
  typePolicies: {
    OnboardingSession: {
      keyFields: ['id'],
      fields: {
        assessment: {
          merge: true, // Deep merge assessment updates
        },
      },
    },
    Message: {
      keyFields: ['id'],
    },
    TherapistMatch: {
      keyFields: ['therapistId'],
    },
  },
});
```

---

## API Contracts

### GraphQL Operation Patterns

```graphql
# Query pattern: Fetch session state
query GetOnboardingSession($id: ID!) {
  getOnboardingSession(id: $id) {
    id
    status
    child {
      firstName
    }
    assessment {
      conversationHistory {
        id
        sender
        content
        timestamp
      }
      isComplete
    }
  }
}

# Mutation pattern: Submit with optimistic update
mutation SubmitAssessmentMessage($input: MessageInput!) {
  submitAssessmentMessage(input: $input) {
    message {
      id
      sender
      content
      timestamp
    }
    aiResponse {
      id
      sender
      content
      timestamp
    }
    nextQuestion
  }
}

# Subscription pattern: Real-time support chat
subscription SupportChatMessages($sessionId: ID!) {
  supportChatMessages(sessionId: $sessionId) {
    id
    sender
    content
    timestamp
    senderName
  }
}
```

### Error Response Format

```typescript
// GraphQL errors follow this structure
interface GraphQLErrorExtensions {
  code: 'VALIDATION_ERROR' | 'UNAUTHENTICATED' | 'NOT_FOUND' | 'INTERNAL_ERROR';
  field?: string; // For validation errors
  retryable?: boolean;
}

// Frontend error handling
const ERROR_MESSAGES: Record<string, string> = {
  VALIDATION_ERROR: 'Please check your input and try again.',
  UNAUTHENTICATED: 'Your session has expired. Please start over.',
  NOT_FOUND: 'Session not found. Please start a new session.',
  INTERNAL_ERROR: 'Something went wrong. Please try again.',
};
```

---

## Security Architecture

### Authentication

```typescript
// JWT stored in memory (not localStorage for XSS protection)
// Refresh handled via httpOnly cookie from backend

// lib/apollo/links.ts
const authLink = setContext((_, { headers }) => {
  const token = getAuthToken(); // From memory/context
  return {
    headers: {
      ...headers,
      authorization: token ? `Bearer ${token}` : '',
    },
  };
});
```

### PHI Protection Checklist

All agents MUST verify before marking story complete:

- [ ] No PHI in `console.log`, `console.error`, or any logging
- [ ] No PHI in URL parameters or fragments
- [ ] No PHI in browser history (use `replace` not `push` for sensitive routes)
- [ ] No PHI in error messages shown to users
- [ ] No PHI in Sentry/error tracking payloads
- [ ] Session tokens use secure, httpOnly cookies where possible
- [ ] Form autofill disabled for sensitive fields (`autoComplete="off"`)

### Third-Party Audit

Approved vendors (HIPAA BAA verified):
- Apollo Client (client-side only, no data sent to Apollo)
- Sentry (with PHI scrubbing configured)
- Vercel Analytics (anonymized, no PHI)

NOT approved (do not add):
- Google Analytics
- Facebook Pixel
- Hotjar/FullStory (session recording)

---

## Performance Considerations

### Performance Budgets

| Metric | Target | Measurement |
|--------|--------|-------------|
| LCP | <1.5s | Core Web Vitals |
| FID | <100ms | Core Web Vitals |
| CLS | <0.1 | Core Web Vitals |
| TTI | <3s | Lighthouse |
| Bundle size (initial) | <150KB gzipped | Bundle analyzer |

### Optimization Strategies

```typescript
// Code splitting: Dynamic imports for heavy features
const InsuranceScanner = dynamic(
  () => import('@/features/insurance/InsuranceScanner'),
  { loading: () => <Skeleton className="h-64" /> }
);

// Image optimization: next/image with proper sizing
<Image
  src="/images/therapist.jpg"
  alt="Therapist photo"
  width={80}
  height={80}
  className="rounded-full"
/>

// Font optimization: next/font with display swap
import { Inter, Fraunces } from 'next/font/google';

const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-inter',
});

// Prefetching: Preload next likely route
<Link href={`/onboarding/${sessionId}/demographics`} prefetch>
  Continue
</Link>
```

---

## Deployment Architecture

### Infrastructure

```
┌─────────────────────────────────────────────────────────────┐
│                      AWS CloudFront                          │
│                    (Global CDN + SSL)                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         AWS S3                               │
│              (Static site hosting - Next.js export)          │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS/WSS
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Aptible (Backend)                       │
│                    Ruby on Rails 7 API                       │
│                   GraphQL + Action Cable                     │
└─────────────────────────────────────────────────────────────┘
```

### Build & Deploy

```bash
# Build static export
pnpm build

# Output: out/ directory with static files
# Deploy to S3:
aws s3 sync out/ s3://daybreak-frontend-prod --delete

# Invalidate CloudFront cache
aws cloudfront create-invalidation --distribution-id XXXXX --paths "/*"
```

### Environment Variables

```bash
# .env.local (development)
NEXT_PUBLIC_GRAPHQL_ENDPOINT=http://localhost:3001/graphql
NEXT_PUBLIC_WS_ENDPOINT=ws://localhost:3001/cable

# Production (set in deployment)
NEXT_PUBLIC_GRAPHQL_ENDPOINT=https://api.daybreakhealth.com/graphql
NEXT_PUBLIC_WS_ENDPOINT=wss://api.daybreakhealth.com/cable
```

---

## Development Environment

### Prerequisites

- **Node.js** 20+ (required for React Hook Form 7.x and modern tooling)
- **pnpm** 9+ (recommended package manager)
- **Backend API** running on `localhost:3001`

### Setup Commands

```bash
# Clone repository
git clone <repo-url>
cd daybreak-health-frontend

# Install dependencies
pnpm install

# Copy environment template
cp .env.example .env.local

# Generate GraphQL types
pnpm codegen

# Start development server
pnpm dev

# Run in parallel with type checking
pnpm dev & pnpm typecheck --watch
```

### Available Scripts

| Command | Description |
|---------|-------------|
| `pnpm dev` | Start dev server with Turbopack |
| `pnpm build` | Build for production (static export) |
| `pnpm start` | Start production server (for testing) |
| `pnpm codegen` | Generate GraphQL types |
| `pnpm codegen:watch` | Watch mode for GraphQL codegen |
| `pnpm test` | Run Vitest unit tests |
| `pnpm test:watch` | Run tests in watch mode |
| `pnpm test:e2e` | Run Playwright E2E tests |
| `pnpm lint` | Run ESLint |
| `pnpm lint:fix` | Fix ESLint issues |
| `pnpm typecheck` | Run TypeScript compiler check |
| `pnpm format` | Format code with Prettier |

---

## Architecture Decision Records (ADRs)

### ADR-001: Separate Frontend/Backend Repositories

**Decision:** Maintain frontend and backend in separate repositories.

**Context:** The system requires a Next.js frontend and Ruby on Rails backend.

**Rationale:**
- Independent deployment cycles
- Clear API boundary (GraphQL)
- Security isolation (PHI only on backend)
- Team specialization

**Consequences:**
- CORS configuration required
- Schema synchronization via GraphQL Codegen
- Two CI/CD pipelines

---

### ADR-002: GraphQL Subscriptions over Action Cable

**Decision:** Use GraphQL Subscriptions with Action Cable as WebSocket transport.

**Context:** Real-time support chat requires bi-directional communication.

**Rationale:**
- Unified GraphQL API for all operations
- Type-safe subscriptions via Codegen
- Rails' native WebSocket support
- No additional infrastructure (Redis optional for MVP via solid_cable)

**Consequences:**
- `graphql-ws` client configuration required
- Reconnection logic in Apollo Link
- Action Cable authentication via JWT

---

### ADR-003: Form-Based Fallback Flow

**Decision:** Implement parallel form-based flow alongside AI chat.

**Context:** Pre-mortem analysis identified AI chat abandonment as critical risk.

**Rationale:**
- Not all parents want to chat with AI
- Fallback for AI service outages
- A/B testing capability
- Accessibility (chat may be harder for some users)

**Consequences:**
- Two parallel route structures
- Shared data collection logic
- Additional testing scope

---

### ADR-004: Zod 3.x over Zod 4.x

**Decision:** Use Zod 3.x for schema validation.

**Context:** Zod 4.x has known issues with React Hook Form integration.

**Rationale:**
- Zod 4.x `zodResolver` throws uncaught errors
- Zod 3.x is stable and well-tested
- Can upgrade when issues are resolved

**Consequences:**
- Use `zod@^3.23` in package.json
- Monitor Zod 4 compatibility updates

---

### ADR-005: Human Support in MVP (Not Growth)

**Decision:** Include human support chat escalation in MVP.

**Context:** Pre-mortem analysis identified "parents feel trapped" as critical risk.

**Rationale:**
- Emotional safety requires human option
- Reduces AI chat abandonment
- Builds trust quickly

**Consequences:**
- Real-time subscription infrastructure needed for MVP
- Staff workflow for handling support requests
- Additional UI component (floating button)

---

## Validation Checklist

Before marking architecture complete:

- [x] Decision table has Version column with specific versions
- [x] Every FR category is mapped to architecture components
- [x] Source tree is complete, not generic
- [x] No placeholder text remains
- [x] All FRs from PRD have architectural support
- [x] All NFRs from PRD are addressed (HIPAA, performance, accessibility)
- [x] Implementation patterns cover all potential conflicts
- [x] Pre-mortem preventive measures are documented

---

## Related Documents

- **Product Requirements:** `docs/prd.md`
- **Frontend Technical Spec:** `docs/frontend-technical-spec.md`
- **UX Design Specification:** `docs/ux-design-specification.md`
- **GraphQL Schema:** `docs/sprint-artifacts/api_schema.graphql`

---

_Generated by BMAD Decision Architecture Workflow v1.0_
_Date: 2025-11-28_
_For: BMad_

**Sources Used:**
- [Next.js Installation](https://nextjs.org/docs/app/getting-started/installation)
- [create-next-app CLI](https://nextjs.org/docs/app/api-reference/cli/create-next-app)
- [Apollo Client Next.js Integration](https://github.com/apollographql/apollo-client-integrations)
- [@apollo/client-integration-nextjs Release](https://www.apollographql.com/blog/apollo-client-integration-nextjs-officially-released)
- [shadcn/ui Next.js Installation](https://ui.shadcn.com/docs/installation/next)
- [shadcn/ui React 19 Compatibility](https://ui.shadcn.com/docs/react-19)
- [React Hook Form Resolvers](https://github.com/react-hook-form/resolvers)
- [GraphQL Codegen typescript-react-apollo](https://the-guild.dev/graphql/codegen/plugins/typescript/typescript-react-apollo)
- [Tailwind CSS v4.0 Release](https://tailwindcss.com/blog/tailwindcss-v4)
